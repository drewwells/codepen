package main

import (
	"bytes"
	"fmt"
	"io"
	"net/http"
	"net/http/httptest"
	"testing"
)

func TestCollection(t *testing.T) {
	ts := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, `{"success":true,"html":"\n<div id=\"pen_grid\" class=\"view-grid\">\n\n    \n<div class=\"group\">\n\n<div class=\"single-pen \" data-slug-hash=\"IhCxf\">\n\n  <div class=\"iframe-wrap\">\n    <a href=\"http://codepen.io/amsul/pen/IhCxf\" class=\"cover-link\"></a>\n\n      <iframe id=\"iframe_embed_374663\" src=\"\"\n        data-slug-hash=\"IhCxf\"\n        data-title=\"pickadate v3: \u201cfrom\u201d &amp; \u201cto\u201d times\"\n        allowTransparency=\"true\" frameborder=\"0\" scrolling=\"no\"\n        data-src=\"http://s.codepen.io/amsul/fullcpgrid/IhCxf\"\n        sandbox=\"allow-scripts allow-pointer-lock allow-same-origin\">\n      </iframe>\n\n    <div class=\"meta-overlay\">\n        <h2>pickadate v3: \u201cfrom\u201d &amp; \u201cto\u201d times</h2>\n        <p><p>extend to get corresponding pickers with \u201cfrom\u201d and \u201dto\u201d behavior with a display of length duration.</p>\n</p>\n    </div>\n\n    <div class=\"context-menu\">\n\n  <span class=\"context-menu-icon\">\n    <span class=\"screen-reader-text\">Menu</span>\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-menu\"></use>\n    </svg>\n  </span>\n\n  <ul>\n    <li>\n      <a href=\"http://codepen.io/amsul/pen/IhCxf\">\n        Open in Editor\n      </a>\n    </li>\n    <li>\n      <a href=\"http://codepen.io/amsul/details/IhCxf\">\n        Open Details Page\n      </a>\n    </li>\n    <li class=\"break\">\n      <a href=\"http://codepen.io/amsul/full/IhCxf\">\n        Open Full Page\n      </a>\n    </li>\n\n    <li>\n      <a href=\"#0\" class=\"add-to-collection-from-flyout\">\n        Add To Collection ...\n      </a>\n    </li>\n  </ul>\n\n</div>\n\n\n  </div>\n\n  <div class=\"meta group\">\n\n      <div class=\"user\">\n\n  <a href=\"/amsul\">\n    <img src=\"//gravatar.com/avatar/092d5acd8c183020f5b96ceebab7d8f0?s=80\" alt=\"User Avatar\" width=\"20\" height=\"20\">\n\n    Amsul\n\n    \n\n  </a>\n</div>\n\n    <div class=\"stats\">\n  <a class=\"single-stat comments\" href=\"http://codepen.io/amsul/details/IhCxf\">\n    0\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-comment\"></use>\n    </svg>\n  </a>\n\n  <a class=\"single-stat views\" href=\"http://codepen.io/amsul/details/IhCxf\">\n    5423\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-eye\"></use>\n    </svg>\n  </a>\n\n  <a id=\"loves_kKavKv\"\n    data-hashid=\"kKavKv\"\n    data-item=\"pen\"\n    class=\"single-stat loves \"\n    data-owned=\"false\">\n\n    <span data-hashid=\"kKavKv\" class=\"count\">\n      5\n    </span>\n    <svg viewBox=\"0 0 100 100\" class=\"icon-heart\">\n      <use xlink:href=\"#icon-heart\"></use>\n    </svg>\n  </a>\n\n</div>\n\n  </div>\n\n</div>\n    <div class=\"single-pen \" data-slug-hash=\"nGckA\">\n\n  <div class=\"iframe-wrap\">\n    <a href=\"http://codepen.io/amsul/pen/nGckA\" class=\"cover-link\"></a>\n\n      <iframe id=\"iframe_embed_371619\" src=\"\"\n        data-slug-hash=\"nGckA\"\n        data-title=\"pickadate v3: \u201cfrom\u201d &amp; \u201cto\u201d dates\"\n        allowTransparency=\"true\" frameborder=\"0\" scrolling=\"no\"\n        data-src=\"http://s.codepen.io/amsul/fullcpgrid/nGckA\"\n        sandbox=\"allow-scripts allow-pointer-lock allow-same-origin\">\n      </iframe>\n\n    <div class=\"meta-overlay\">\n        <h2>pickadate v3: \u201cfrom\u201d &amp; \u201cto\u201d dates</h2>\n        <p><p>extend to get corresponding pickers with \u201cfrom\u201d and \u201dto\u201d behavior.</p>\n</p>\n    </div>\n\n    <div class=\"context-menu\">\n\n  <span class=\"context-menu-icon\">\n    <span class=\"screen-reader-text\">Menu</span>\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-menu\"></use>\n    </svg>\n  </span>\n\n  <ul>\n    <li>\n      <a href=\"http://codepen.io/amsul/pen/nGckA\">\n        Open in Editor\n      </a>\n    </li>\n    <li>\n      <a href=\"http://codepen.io/amsul/details/nGckA\">\n        Open Details Page\n      </a>\n    </li>\n    <li class=\"break\">\n      <a href=\"http://codepen.io/amsul/full/nGckA\">\n        Open Full Page\n      </a>\n    </li>\n\n    <li>\n      <a href=\"#0\" class=\"add-to-collection-from-flyout\">\n        Add To Collection ...\n      </a>\n    </li>\n  </ul>\n\n</div>\n\n\n  </div>\n\n  <div class=\"meta group\">\n\n      <div class=\"user\">\n\n  <a href=\"/amsul\">\n    <img src=\"//gravatar.com/avatar/092d5acd8c183020f5b96ceebab7d8f0?s=80\" alt=\"User Avatar\" width=\"20\" height=\"20\">\n\n    Amsul\n\n    \n\n  </a>\n</div>\n\n    <div class=\"stats\">\n  <a class=\"single-stat comments\" href=\"http://codepen.io/amsul/details/nGckA\">\n    1\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-comment\"></use>\n    </svg>\n  </a>\n\n  <a class=\"single-stat views\" href=\"http://codepen.io/amsul/details/nGckA\">\n    6281\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-eye\"></use>\n    </svg>\n  </a>\n\n  <a id=\"loves_kGrWjZ\"\n    data-hashid=\"kGrWjZ\"\n    data-item=\"pen\"\n    class=\"single-stat loves \"\n    data-owned=\"false\">\n\n    <span data-hashid=\"kGrWjZ\" class=\"count\">\n      9\n    </span>\n    <svg viewBox=\"0 0 100 100\" class=\"icon-heart\">\n      <use xlink:href=\"#icon-heart\"></use>\n    </svg>\n  </a>\n\n</div>\n\n  </div>\n\n</div>\n    <div class=\"single-pen \" data-slug-hash=\"cBuAl\">\n\n  <div class=\"iframe-wrap\">\n    <a href=\"http://codepen.io/amsul/pen/cBuAl\" class=\"cover-link\"></a>\n\n      <iframe id=\"iframe_embed_369377\" src=\"\"\n        data-slug-hash=\"cBuAl\"\n        data-title=\"pickadate v3: typing and date.js parsing\"\n        allowTransparency=\"true\" frameborder=\"0\" scrolling=\"no\"\n        data-src=\"http://s.codepen.io/amsul/fullcpgrid/cBuAl\"\n        sandbox=\"allow-scripts allow-pointer-lock allow-same-origin\">\n      </iframe>\n\n    <div class=\"meta-overlay\">\n        <h2>pickadate v3: typing and date.js parsing</h2>\n        <p><p>parsing a user typed date string using datejs and using pickadate.js as the date picker.</p>\n</p>\n    </div>\n\n    <div class=\"context-menu\">\n\n  <span class=\"context-menu-icon\">\n    <span class=\"screen-reader-text\">Menu</span>\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-menu\"></use>\n    </svg>\n  </span>\n\n  <ul>\n    <li>\n      <a href=\"http://codepen.io/amsul/pen/cBuAl\">\n        Open in Editor\n      </a>\n    </li>\n    <li>\n      <a href=\"http://codepen.io/amsul/details/cBuAl\">\n        Open Details Page\n      </a>\n    </li>\n    <li class=\"break\">\n      <a href=\"http://codepen.io/amsul/full/cBuAl\">\n        Open Full Page\n      </a>\n    </li>\n\n    <li>\n      <a href=\"#0\" class=\"add-to-collection-from-flyout\">\n        Add To Collection ...\n      </a>\n    </li>\n  </ul>\n\n</div>\n\n\n  </div>\n\n  <div class=\"meta group\">\n\n      <div class=\"user\">\n\n  <a href=\"/amsul\">\n    <img src=\"//gravatar.com/avatar/092d5acd8c183020f5b96ceebab7d8f0?s=80\" alt=\"User Avatar\" width=\"20\" height=\"20\">\n\n    Amsul\n\n    \n\n  </a>\n</div>\n\n    <div class=\"stats\">\n  <a class=\"single-stat comments\" href=\"http://codepen.io/amsul/details/cBuAl\">\n    0\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-comment\"></use>\n    </svg>\n  </a>\n\n  <a class=\"single-stat views\" href=\"http://codepen.io/amsul/details/cBuAl\">\n    4764\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-eye\"></use>\n    </svg>\n  </a>\n\n  <a id=\"loves_nLxbNR\"\n    data-hashid=\"nLxbNR\"\n    data-item=\"pen\"\n    class=\"single-stat loves \"\n    data-owned=\"false\">\n\n    <span data-hashid=\"nLxbNR\" class=\"count\">\n      15\n    </span>\n    <svg viewBox=\"0 0 100 100\" class=\"icon-heart\">\n      <use xlink:href=\"#icon-heart\"></use>\n    </svg>\n  </a>\n\n</div>\n\n  </div>\n\n</div>\n    <div class=\"single-pen \" data-slug-hash=\"Fsyav\">\n\n  <div class=\"iframe-wrap\">\n    <a href=\"http://codepen.io/amsul/pen/Fsyav\" class=\"cover-link\"></a>\n\n      <iframe id=\"iframe_embed_371082\" src=\"\"\n        data-slug-hash=\"Fsyav\"\n        data-title=\"pickadate v3: scrolling picker into view\"\n        allowTransparency=\"true\" frameborder=\"0\" scrolling=\"no\"\n        data-src=\"http://s.codepen.io/amsul/fullcpgrid/Fsyav\"\n        sandbox=\"allow-scripts allow-pointer-lock allow-same-origin\">\n      </iframe>\n\n    <div class=\"meta-overlay\">\n        <h2>pickadate v3: scrolling picker into view</h2>\n        <p><p>scroll the date picker into view when the picker is opened.</p>\n</p>\n    </div>\n\n    <div class=\"context-menu\">\n\n  <span class=\"context-menu-icon\">\n    <span class=\"screen-reader-text\">Menu</span>\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-menu\"></use>\n    </svg>\n  </span>\n\n  <ul>\n    <li>\n      <a href=\"http://codepen.io/amsul/pen/Fsyav\">\n        Open in Editor\n      </a>\n    </li>\n    <li>\n      <a href=\"http://codepen.io/amsul/details/Fsyav\">\n        Open Details Page\n      </a>\n    </li>\n    <li class=\"break\">\n      <a href=\"http://codepen.io/amsul/full/Fsyav\">\n        Open Full Page\n      </a>\n    </li>\n\n    <li>\n      <a href=\"#0\" class=\"add-to-collection-from-flyout\">\n        Add To Collection ...\n      </a>\n    </li>\n  </ul>\n\n</div>\n\n\n  </div>\n\n  <div class=\"meta group\">\n\n      <div class=\"user\">\n\n  <a href=\"/amsul\">\n    <img src=\"//gravatar.com/avatar/092d5acd8c183020f5b96ceebab7d8f0?s=80\" alt=\"User Avatar\" width=\"20\" height=\"20\">\n\n    Amsul\n\n    \n\n  </a>\n</div>\n\n    <div class=\"stats\">\n  <a class=\"single-stat comments\" href=\"http://codepen.io/amsul/details/Fsyav\">\n    0\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-comment\"></use>\n    </svg>\n  </a>\n\n  <a class=\"single-stat views\" href=\"http://codepen.io/amsul/details/Fsyav\">\n    3944\n    <svg viewBox=\"0 0 100 100\">\n      <use xlink:href=\"#icon-eye\"></use>\n    </svg>\n  </a>\n\n  <a id=\"loves_AvggVw\"\n    data-hashid=\"AvggVw\"\n    data-item=\"pen\"\n    class=\"single-stat loves \"\n    data-owned=\"false\">\n\n    <span data-hashid=\"AvggVw\" class=\"count\">\n      5\n    </span>\n    <svg viewBox=\"0 0 100 100\" class=\"icon-heart\">\n      <use xlink:href=\"#icon-heart\"></use>\n    </svg>\n  </a>\n\n</div>\n\n  </div>\n\n</div>\n\n</div>\n\n\n\n  </div>\n\n","gridID":"#collections-pens-grid","pageType":"collections","popstateEvent":"false","getPageURL":"/collection/vLcih/","ajaxURL":"/collection/next_grid_for_collection/vLcih?page=1&popstateEvent=false&size=small&q=&selected_tag=&love_item=null&love_type=loved&turn_off_js=false&m=false","updateURL":true}`)
	}))

	defer ts.Close()

	res, err := http.Get(ts.URL)
	if err != nil {
		t.Fatal(err)
	}
	defer res.Body.Close()
	bs, err := parseCollection(res.Body)
	if err != io.EOF && err != nil {
		t.Error(err)
	}
	e := []byte(`[{"pen":"http://codepen.io/amsul/details/Fsyav","url":"Fsyav","comments":0,"views":3944,"loves":5},{"pen":"http://codepen.io/amsul/details/cBuAl","url":"cBuAl","comments":0,"views":4764,"loves":15},{"pen":"http://codepen.io/amsul/details/nGckA","url":"nGckA","comments":1,"views":6281,"loves":9},{"pen":"http://codepen.io/amsul/details/IhCxf","url":"IhCxf","comments":0,"views":5423,"loves":5}]`)
	if bytes.Compare(bs, e) != 0 {
		t.Errorf("got:\n%s\nwanted:\n%s", string(bs), string(e))
	}
}
